const fs = require('fs');
const path = require('path');

// Paths
const packageJsonPath = path.join(__dirname, '../package.json');
const swPath = path.join(__dirname, '../public/sw.js');
const versionFilePath = path.join(__dirname, '../src/lib/app-version.ts');

// Read package.json
const packageJson = require(packageJsonPath);
const version = packageJson.version;

console.log(`üì¶ Syncing version ${version} to App and Service Worker...`);

// 1. Update Service Worker (public/sw.js)
if (fs.existsSync(swPath)) {
    let swContent = fs.readFileSync(swPath, 'utf8');
    // Regex to find: const CACHE_NAME = '...';
    // We want to replace the value inside quotes
    const cacheNameRegex = /const CACHE_NAME = ['"](.*)['"];/;

    if (cacheNameRegex.test(swContent)) {
        const newCacheName = `app-cache-v${version}`;
        swContent = swContent.replace(cacheNameRegex, `const CACHE_NAME = '${newCacheName}';`);
        fs.writeFileSync(swPath, swContent, 'utf8');
        console.log(`‚úÖ Updated Service Worker cache name to: ${newCacheName}`);
    } else {
        console.warn('‚ö†Ô∏è Could not find CACHE_NAME definition in public/sw.js');
    }
} else {
    console.error('‚ùå public/sw.js not found!');
}

// 2. Create/Update Version File for App UI (src/lib/app-version.ts)
// Ensure dir exists
const libDir = path.dirname(versionFilePath);
if (!fs.existsSync(libDir)) {
    fs.mkdirSync(libDir, { recursive: true });
}

const versionFileContent = `// This file is auto-generated by scripts/update-build-info.js
// Do not edit manually.
export const APP_VERSION = 'v${version}';
`;

fs.writeFileSync(versionFilePath, versionFileContent, 'utf8');
console.log(`‚úÖ Updated src/lib/app-version.ts with version: v${version}`);
